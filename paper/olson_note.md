# AprilTag： 一个健壮而灵活的视觉基准系统

> 使用自然出现的特征一直是机器感知的重点，但人造特征在一些实验中也扮演了很重要的角色，可以简化一些并不关注自然特征的系统。论文设计了一种使用二维码的视觉基准系统，可以从单张图像中实现六个自由度上的定位。这一系统融合了之前的直线检测、数字编码技术，对遮挡、扭曲、镜头失真有更好的效果。虽然在概念上类似于ARTag系统，但这一方法是完全开源的，算法也有详细的文档。

## Introduction

虽然和QR码很像，但视觉基准码有完全不同的目标和应用。使用QR码时，通常需要将摄像头与标签对齐，然后以相当高的分辨率拍摄它，获得数百个字节，比如一个网址。相比之下，视觉基准码只承载很小的信息（也许是12位），但即使它的分辨率非常低、光线不均匀、旋转异常或隐藏在图像的角落里，也能被自动检测和定位。为了便于检测，视觉基准码包含更少的信息。

视觉基准系统最著名的应用可能是在增强现实中，这刺激了几个流行系统的发展，包括ARToolkit和ARTag。现实世界的物体可以用视觉基准系统定位，叠加上虚拟生成的图像。同样，视觉基准还可用于基本动作捕捉。

设计一个优秀的视觉基准系统的难点来自于两方面：视觉检测以及信息编码。

下文分三个部分介绍AprilTag：标签检测器、编码系统、评估对比。

## 检测器

检测器的主要功能就是在图片中寻找可能存在的标签，或者说“内部颜色深的方形”。

检测器设计为很低的假阴率，所以就有一个很高的假阳率。（真假表示识别正确与否，阴阳表示识别的结果是真或假）编码系统会补偿这一过高的假阳率。

### 直线检测

> 计算像素的梯度→按照梯度大小排序→以梯度方向作为约束进行聚类→最小二乘计算直线

我们的方法从检测图像中的线开始。我们的方法与ARTag检测器的基本方法相似，计算每个像素点的梯度方向和梯度大小，并将像素点聚类成梯度方向和梯度大小相似的分量。

该聚类算法类似于Felzenszwalb的基于图的方法：创建一个图，每个节点代表一个像素。在相邻像素之间添加边，边权等于像素在梯度方向上的差值。然后将这些边按边权递增的方式进行排序处理：对于每条边，我们测试其两侧像素所属的集群是否应该连接在一起。假设一个集群n，我们把其中像素梯度方向的范围记为D(n)，梯度大小的范围记为M(n)。也就是说，D(n)和M(n)是标量值，分别表示梯度方向和梯度大小的最大值和最小值之差。对于D()，必须小心处理2π周期。然而，由于有用的边的跨度要比π小得多，这就很简单了。

给定n和m两个集群，如果满足以下两个条件，我们将它们连接在一起：

$$D(n \cup m) \leq \min (D(n), D(m))+K_{D} /|n \cup m|$$

$$M(n \cup m) \leq \min (M(n), M(m))+K_{M} /|n \cup m|$$

条件由[19]改编而来，可以直观理解：D()和M()值小，表示分量内部变化小。如果两个集群的联合和单独使用的集群一样一致，则将它们连接在一起。K<sub>D</sub>、K<sub>M</sub>参数允许分量内变化的适度增加，但随着分量变大，这种变化会迅速缩小。在早期的迭代中，K参数本质上允许每个集群“学习”其簇内的变化。在我们的实验中，我们使用了K<sub>D</sub>=100和K<sub>M</sub>=1200，尽管该算法在广泛的值范围内都工作得很好。

（？）由于性能原因，边缘权值被量化并存储为定点数。这允许边缘使用线性时间计数排序[20]。使用unionfind算法[20]可以有效地进行实际的合并操作，并将梯度方向和幅度的上界和下界存储在一个简单的数组中，该数组由每个分量的代表成员索引。

这种基于梯度的聚类方法对图像中的噪声很敏感，即使是少量的噪声也会引起局部梯度方向的变化，抑制了成分的增长。解决这个问题的方法是对图像进行低通滤波。与其他问题域不同，这种过滤可以模糊图像中的有用信息，标签的边缘本质上是大规模的特征（特别是与数据字段相比），因此这种过滤不会导致信息丢失。我们推荐σ=0.8。

（？）聚类操作完成后，使用传统的最小二乘方法将线段附加到互相连接的组件上，加权每个点的梯度大小（见图3）。我们调整每个线段，使其阴暗面在左，亮面在右。在处理的下一个阶段中，这允许我们在每个四轴上执行一个缠绕规则。

分割算法是我们的检测方案中最慢的阶段。作为一种解决方案，这个分割可以用图像的一半分辨率执行，以提高速度。子采样操作可以与推荐的低通滤波器有效地结合。这种优化的结果是适度减少检测范围，因为非常小的矩形可能不再被检测。

### 矩形检测

> 深度优先搜索→按逆时针顺序考虑线段组合→二维查找表加速

此时，已经为图像计算了一组有向线段。下一个任务是找到一系列的线段，形成一个矩形，同时对于遮挡和噪声尽可能健壮。

我们的方法基于深度为4的递归深度优先搜索：搜索树的每一层都向矩形添加一条边。在深度1，我们考虑所有的线段。在深度2到4，我们考虑这些线段：它们的起点和上一个线段的终点足够“接近”，且遵循逆时针的旋转顺序。通过调整“接近”的阈值来实现对遮挡和分割错误的健壮性：通过使阈值较大，可以处理边缘周围的显著间隙。我们的“接近”阈值是两倍的线长加上五个额外的像素。这是一个很大的阈值，导致了低的假阴性率，但也导致了高的假阳性率。

我们添加了一个二维查找表，以加速对起点在某点附近的线段的查询。通过这种优化，以及对不遵守缠绕规则或多次使用一个线段的前期筛选，矩形检测算法只占总计算需求的一小部分。

（？）一旦找到了四行，就会创建一个候选的矩形。这个矩形的角是组成它的线的交点。因为这些线条是用来自多个像素的数据拟合的，所以这些角的估计精确到一个像素的一小部分。

### 单应性变换和外参估计

（？）标签坐标系：[0 0 1]<sup>T</sup>在标签的中心，标签在x和y方向上扩展一个维度

（？）我们计算一个3×3的单应性矩阵，which能将二维点从标签坐标系中以齐次坐标投影到二维图像坐标系。这一步是利用直接线性变换(DLT)算法[22]计算。注意，由于单应性在齐次坐标中投影点，因此只按比例定义。

（？）标签的位置和方向的计算需要额外的信息:相机的焦距和标签的物理尺寸。由DLT计算的3×3单应性矩阵可以写成3×4摄像机投影矩阵P(假设已知)和4x3截断的外参矩阵E的乘积。外参矩阵通常为4×4，但在标签坐标系中，标签上的每个位置都在z=0处。因此，我们可以将每个标签坐标重写为二维齐次点，z轴忽略为0，并去除外参矩阵的第三列，形成截断的外参矩阵，我们将P的旋转分量表示为R<sub>ij</sub>，平移分量表示为T<sub>h</sub>，同时将未知的尺度因子表示为s：

$$\left[\begin{array}{cccc}
h_{00} & h_{01} & h_{02} \\
h_{10} & h_{11} & h_{12} \\
h_{20} & h_{21} & h_{22}
\end{array}\right]=s P E
=s\left[\begin{array}{cccc}
f_{x} & 0 & 0 & 0 \\
0 & f_{y} & 0 & 0 \\
0 & 0 & 1 & 0
\end{array}\right]\left[\begin{array}{ccc}
R_{00} & R_{01} & T_{x} \\
R_{10} & R_{11} & T_{y} \\
R_{20} & R_{21} & T_{z} \\
0 & 0 & 1
\end{array}\right]$$

（？）注意，我们不能直接解出E，因为P不是满秩的。我们可以将等式的右侧展开，将每个h<sub>ij</sub>的表达式写成联立方程组：

$$\begin{aligned}
h_{00} &=s R_{00} f_{x} \\
h_{01} &=s R_{01} f_{x} \\
h_{02} &=s T_{x} f_{x} \\
...
\end{aligned}$$

（？）这些都是很容易解决的，除了未知的元素比例因子s。然而,由于一个旋转矩阵的列必须所有的单元大小,我们可以限制的s大小。我们有两个旋转矩阵的列,所以我们计算年代的几何几何平均大小。通过要求标签出现在摄像机前面，即T < 0，可以恢复s的符号。通过计算已知两列向量的叉积，可以求出旋转矩阵的第三列。因为一个旋转矩阵的列必须是标准正交的。

（？）上述DLT过程和归一化过程并不能保证旋转矩阵是严格标准正交的。为了修正这个，我们计算极坐标decom-。在使误差[23]的弗洛贝尼厄斯矩阵范数最小化的同时，得到一个合适的旋转矩阵。

## 信息解码

最后一个任务是从有效负载字段读取位。我们通过计算每个位域的标签相对坐标，使用单应性将其转换为图像坐标，然后对结果像素进行阈值处理来实现这一点。为了增强光照的稳定性(光照不仅可以根据标签的不同而变化，而且也可以根据标签的不同而变化)，我们使用了一个空间变化的阈值。